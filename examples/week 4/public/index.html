<meta charset="UTF-8" />
<meta name="google" content="notranslate" />
<meta http-equiv="Content-Language" content="en" />
<style>
  body {
    margin: 0 auto;
    width: 600px;
  }
  ul {
    align-content: space-around;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    list-style-type: none;
    margin-top: -0.5em;
    padding: 0;
    space-between: space-evenly;
    width: 100%;
  }
  li {
    border: 5px blue dotted;
    color: blue;
    font-size: 1.5em;
    height: 60px;
    margin: 1em 0.75em 0;
    padding: 0.75em;
    width: 190px;
  }
  form input {
    width: 100%;
  }
</style>

<div style="text-align: center;">
  <img src="/static/lol.png" style="width: 200px;" />
  <h1>Joke Teller</h1>
  <div>Would you like to hear ...?</div>
  <ul>
    <li id="random">Random Joke</li>
    <li id="bestKnock">Our Best <nobr>Knock-Knock</nobr> Joke</li>
  </ul>
  <div>Or would you prefer to see a list of all ...?</div>
  <ul>
    <li id="chickenJokes">Chicken Crossing the Road Jokes</li>
    <li id="knockJokes">Knock-Knock Jokes</li>
  </ul>
</div>
<hr />
<h2>Add a Joke</h2>

<form id="addForm">
  <p>
    <label>ID: <input name="id" placeholder="7"/></label>
  </p>
  <p>
    <label
      >Title: <input name="title" placeholder="Two Fonts Walk Into  a Bar"
    /></label>
  </p>
  <p>
    <label
      >Question:
      <input
        name="question"
        placeholder="Helvetica and Times New Roman walk into a bar"
    /></label>
  </p>
  <p>
    <label
      >Answer:
      <input
        name="answer"
        placeholder="The bartender tells them, get out of here: we donâ€™t serve your type."
    /></label>
  </p>
  <p>
    <label>Created By: <input name="created_by" placeholder="1"/></label>
  </p>
  <input type="submit" />
</form>

<h2>Delete a Joke</h2>
<form id="deleteForm">
  <label>ID: <input name="id" placeholder="7"/></label>
  <input type="submit" />
</form>
<script>
  /**
   * "Tells" a joke to the user by alerting it's question and answer
   */
  const tellJoke = ({ question, answer }) =>
    alert(`Question: ${question + '\n'} Answer: ${answer}`);

  /**
   * Fetches a single random joke, then "tells" (alerts) that joke
   */
  const alertRandom = async () => {
    const response = await fetch('/api/random');
    const joke = await response.json();
    tellJoke(joke);
  };

  /**
   * Fetches a single specific joke by ID, then "tells" (alerts) that joke
   */
  const alertSpecific = async jokeId => {
    const response = await fetch('/api/joke/' + jokeId);
    const joke = await response.json();
    tellJoke(joke);
  };

  /**
   * Fetches a category's worth of jokes, then alerts the number of jokes in
   * that category, and finally "tells" (alerts) each of those jokes
   */
  const alertCategory = async category => {
    const response = await fetch('/api/search?category=' + category);
    const jokes = await response.json();
    if (jokes.length > 1) {
      alert(`There were ${jokes.length} jokes in that category...`);
    } else if (jokes.length) {
      alert(`We have one joke in that category.  It is ...`);
    }
    jokes.forEach(tellJoke);
  };

  /**
   * Finds the indicated field in the indicated form, and returns its value (or
   * placeholder value)
   */
  const parseField = (formId, fieldName) => {
    const inputSelector = `#${formId} [name="${fieldName}"]`;
    const input = document.querySelector(inputSelector);
    return input.value || input.placeholder;
  };

  // List of all of our (input) joke fields.
  // (We'll let the server set the joke's creation date)
  const fields = ['id', 'title', 'question', 'answer', 'created_by'];

  /**
   * Given the ID of a form, parses the values (or placeholder values) in the
   * inputs of that form, to create a joke object
   */
  const parseForm = formId => {
    const joke = fields.reduce((joke, field) => {
      joke[field] = parseField(formId, field); // eg. joke.id = "5"
      return joke;
    }, {});
    joke.id = parseFloat(joke.id);
    joke.created_by = parseFloat(joke.created_by);
    return joke;
  };

  /**
   * Makes a request to the server using the provide URL/parameters, and then
   * returns a boolean indicating whether or not it was succesful.  If an error
   * occurs it will be logged, and the user notified.
   */
  const makeRequest = async (url, params) => {
    try {
      const response = await fetch(url, params);
      // Handle HTTP-level errors
      if (!response.ok) throw new Error(response.statusText);

      const responseJson = await response.json();
      // Handle API/data errors
      if (!responseJson.success) throw new Error(responseJson.message);
      return true;
    } catch (err) {
      console.error(err);
      alert(
        'An error ocurred (please check the console and network tabs of your ' +
          'developer tools).'
      );
    }
    return false;
  };

  /**
   * Parse the form to get a new joke's details, then POST them to the server
   */
  const addJoke = async e => {
    e.preventDefault();
    const joke = parseForm('addForm');
    const wasSuccess = await makeRequest('/api/addJoke', {
      headers: { 'Content-Type': 'application/json' },
      method: 'POST',
      body: JSON.stringify(joke)
    });
    if (wasSuccess) alert('Your joke was added successfully!');
  };

  /**
   * Parse the form to dtermine which joke to delete, then send its ID to the
   * server so it can be deleted
   */
  const deleteJoke = async e => {
    e.preventDefault();
    const { id } = parseForm('addForm');
    const wasSuccess = await makeRequest('/api/deleteJoke?id=' + id);
    if (wasSuccess) alert('Your joke was deleted successfully!');
  };

  // Hook up all of our event listeners
  document.getElementById('random').addEventListener('click', alertRandom);
  document
    .getElementById('bestKnock')
    .addEventListener('click', () => alertSpecific(5));
  document
    .getElementById('chickenJokes')
    .addEventListener('click', () => alertCategory(1));
  document
    .getElementById('knockJokes')
    .addEventListener('click', () => alertCategory(1));
  document.getElementById('addForm').addEventListener('submit', addJoke);
  document.getElementById('deleteForm').addEventListener('submit', deleteJoke);
</script>
